From 66a99a642aef3fcdb0dfb7b996ab9938119381fb Mon Sep 17 00:00:00 2001
From: Vasilij Schneidermann <mail@vasilij.de>
Date: Mon, 3 Sep 2018 11:21:44 +0200
Subject: [PATCH] C5 compatibility

---
 build-socket-config     |  5 +++++
 build-socket-config.bat |  5 +++++
 socket-config.scm       | 45 +++++++++++++++++++++++++++++++++++++++++
 socket-features.scm     |  5 ++++-
 socket-mod.scm          |  2 +-
 socket-options.scm      |  7 +++++--
 socket.egg              | 17 ++++++++++++++++
 socket.meta             |  7 -------
 socket.scm              | 42 ++++++++++++++++++++++----------------
 socket.setup            | 18 -----------------
 10 files changed, 107 insertions(+), 46 deletions(-)
 create mode 100755 build-socket-config
 create mode 100755 build-socket-config.bat
 create mode 100644 socket-config.scm
 create mode 100644 socket.egg
 delete mode 100644 socket.meta
 delete mode 100644 socket.setup

diff --git a/build-socket-config b/build-socket-config
new file mode 100755
index 0000000..7061553
--- /dev/null
+++ b/build-socket-config
@@ -0,0 +1,5 @@
+#!/bin/sh
+"$CHICKEN_CSC" -C "$CFLAGS" -L "$LDFLAGS" socket-features.scm
+echo "(import scheme)" > socket-config.scm
+echo "(import (chicken platform))" >> socket-config.scm
+./socket-features >> socket-config.scm
diff --git a/build-socket-config.bat b/build-socket-config.bat
new file mode 100755
index 0000000..952a150
--- /dev/null
+++ b/build-socket-config.bat
@@ -0,0 +1,5 @@
+@echo off
+%CHICKEN_CSC% -C %CFLAGS% -L %LDFLAGS% socket-features.scm
+echo "(import scheme)" > socket-config.scm
+echo "(import (chicken platform))" >> socket-config.scm
+./socket-features >> socket-config.scm
diff --git a/socket-config.scm b/socket-config.scm
new file mode 100644
index 0000000..bf29cbc
--- /dev/null
+++ b/socket-config.scm
@@ -0,0 +1,45 @@
+(import scheme)
+(import (chicken platform))
+(register-feature! 'AF_UNIX)
+(unregister-feature! 'SO_USELOOPBACK)
+(register-feature! 'SO_REUSEPORT)
+(register-feature! 'SO_TIMESTAMP)
+(unregister-feature! 'SO_EXCLUSIVEADDRUSE)
+(register-feature! 'TCP_MAXSEG)
+(unregister-feature! 'TCP_NOPUSH)
+(unregister-feature! 'TCP_NOOPT)
+(unregister-feature! 'TCP_KEEPALIVE)
+(register-feature! 'IP_MTU)
+(register-feature! 'IP_MTU_DISCOVER)
+(register-feature! 'IP_PKTINFO)
+(register-feature! 'IP_RECVERR)
+(register-feature! 'IP_RECVTOS)
+(register-feature! 'IP_RECVTTL)
+(register-feature! 'IP_ROUTER_ALERT)
+(register-feature! 'IP_RECVOPTS)
+(register-feature! 'IP_RECVRETOPTS)
+(register-feature! 'IP_RETOPTS)
+(unregister-feature! 'IP_RECVDSTADDR)
+(register-feature! 'IPV6_V6ONLY)
+(register-feature! 'IPV6_ADDRFORM)
+(register-feature! 'IPV6_MTU)
+(register-feature! 'IPV6_MTU_DISCOVER)
+(register-feature! 'IPV6_MULTICAST_HOPS)
+(register-feature! 'IPV6_MULTICAST_IF)
+(register-feature! 'IPV6_MULTICAST_LOOP)
+(register-feature! 'IPV6_PKTINFO)
+(register-feature! 'IPV6_RTHDR)
+(register-feature! 'IPV6_AUTHHDR)
+(register-feature! 'IPV6_DSTOPTS)
+(register-feature! 'IPV6_HOPOPTS)
+(unregister-feature! 'IPV6_FLOWINFO)
+(register-feature! 'IPV6_HOPLIMIT)
+(register-feature! 'IPV6_RECVERR)
+(register-feature! 'IPV6_ROUTER_ALERT)
+(register-feature! 'IPV6_UNICAST_HOPS)
+(register-feature! 'IPV6_NEXTHOP)
+(unregister-feature! 'IPV6_PORT_RANGE)
+(register-feature! 'IPV6_JOIN_GROUP)
+(register-feature! 'IPV6_LEAVE_GROUP)
+(register-feature! 'IPV6_CHECKSUM)
+(register-feature! 'IPPROTO_IPV6)
diff --git a/socket-features.scm b/socket-features.scm
index 5cabc07..f4762cf 100644
--- a/socket-features.scm
+++ b/socket-features.scm
@@ -1,4 +1,7 @@
-(use feature-test)
+(import scheme)
+(import (chicken base))
+(import (chicken foreign))
+(import feature-test)
 
 #> #include "socket.h" <#
 
diff --git a/socket-mod.scm b/socket-mod.scm
index f65328b..f1a3fdb 100644
--- a/socket-mod.scm
+++ b/socket-mod.scm
@@ -76,7 +76,7 @@
 ;; NB importing scheme here so eval inside read-syntax works in included
 ;; files.  The include seems to reset the eval environment to what's imported
 ;; in this module by the include point.
-(import scheme (only chicken include))
+(import scheme (chicken base))
 (include "socket.scm")
 
 )
diff --git a/socket-options.scm b/socket-options.scm
index ed29bff..6a3c65a 100644
--- a/socket-options.scm
+++ b/socket-options.scm
@@ -1,7 +1,10 @@
 ;;; Local macros
 
-;;(require-library srfi-13) ;;?
-(import-for-syntax srfi-13)
+(import scheme)
+(import (chicken syntax))
+(begin-for-syntax
+ (import (chicken string))
+ (import (srfi 13)))
 
 ;; ;; (local 'ip/multicast-ttl) => '_ip_multicast_ttl
 ;; (define-for-syntax (local s)
diff --git a/socket.egg b/socket.egg
new file mode 100644
index 0000000..c02f0fa
--- /dev/null
+++ b/socket.egg
@@ -0,0 +1,17 @@
+(
+(synopsis "Interface to the BSD socket API")
+(author "Jim Ursetto")
+(dependencies srfi-13 srfi-18 foreigners feature-test)
+(license "BSD")
+(category net)
+(components (generated-source-file socket-config
+                                   (custom-build "build-socket-config")
+                                   (source "socket-features.scm"))
+            (extension socket
+                       (source "socket-mod.scm")
+                       (component-dependencies socket-config)
+                       (csc-options "-O2" "-d1"
+                                    "-X" "socket-config"
+                                    "-X" "feature-test-syntax"
+                                    "-D" "scan-buffer-line-returns-3-vals")))
+)
diff --git a/socket.meta b/socket.meta
deleted file mode 100644
index 0e0745c..0000000
--- a/socket.meta
+++ /dev/null
@@ -1,7 +0,0 @@
-(
-(synopsis "Interface to the BSD socket API")
-(author "Jim Ursetto")
-(needs foreigners feature-test)
-(license "BSD")
-(category net)
-)
diff --git a/socket.scm b/socket.scm
index cdfeda9..660115a 100644
--- a/socket.scm
+++ b/socket.scm
@@ -37,13 +37,24 @@
 ;; OF THE POSSIBILITY OF SUCH DAMAGE.
 
 
-(import scheme (except chicken errno) foreign)
-(use foreigners)
-(use srfi-4 extras ports)
-(use (only srfi-13 string-index))
+(import scheme)
+(import (chicken foreign))
+(import (chicken format))
+(import (chicken syntax))
+(begin-for-syntax
+ (import (chicken format)))
+(import (chicken fixnum))
+(import (chicken port))
+(import (chicken time))
+(import (chicken condition))
+(import (chicken blob))
+(import (srfi 4))
+(import (only (srfi 13) string-index))
+(import (srfi 18))
+(import foreigners)
 ;; Pull TCP in w/o importing so ##sys#tcp-port->fileno is defined
 ;; and network is started up.
-(require-library tcp)
+;; (require-library tcp)
 
 #> #include "socket.h" <#
 
@@ -96,12 +107,13 @@
 ;; (define-for-syntax (c-name sym)
 ;;   (string-translate (string-upcase (symbol->string sym)) "/" "_"))
 (define-syntax define-foreign-flag
-  (lambda (e r c)
-    (let ((name (cadr e)))
-      `(,(r 'begin)
-        (,(r 'foreign-declare)
-         ,(sprintf "#ifndef ~A\n#define ~A 0\n#endif\n" name name))
-        (,(r 'define-foreign-variable) ,name ,(r 'int) ,(symbol->string name))))))
+  (er-macro-transformer
+   (lambda (e r c)
+     (let ((name (cadr e)))
+       `(,(r 'begin)
+         (,(r 'foreign-declare)
+          ,(sprintf "#ifndef ~A\n#define ~A 0\n#endif\n" name name))
+         (,(r 'define-foreign-variable) ,name ,(r 'int) ,(symbol->string name)))))))
 
 (define-foreign-enum-type (address-family int)
   (address-family->integer integer->address-family)
@@ -110,7 +122,7 @@
   ((af/inet6 AF_INET6) AF_INET6)
 ;; #+AF_UNIX ((af/unix AF_UNIX) AF_UNIX)
   )
-#+AF_UNIX (define-foreign-variable AF_UNIX int AF_UNIX)
+#+AF_UNIX (define-foreign-variable AF_UNIX int "AF_UNIX")
 (define af/unspec AF_UNSPEC)
 (define af/inet AF_INET)
 (define af/inet6 AF_INET6)
@@ -593,8 +605,6 @@
         (network-error/errno 'socket "unable to set socket to non-blocking" so))
       so)))
 
-(use srfi-18)
-
 ;; Stolen from sql-de-lite (itself stolen from sqlite), but modified to respect
 ;; actual elapsed time instead of estimated elapsed time (to mostly avoid scheduling jitter).
 ;; The polling intervals are not altered, only the total elapsed time.
@@ -618,8 +628,6 @@
                        (thread-sleep! (/ delay 1000)) ;; silly division
                        #t)))))))))))
 
-(define-constant +largest-fixnum+ (##sys#fudge 21)) 
-
 ;; Returns a special "transient" error (exn i/o net transient) if connection failure
 ;; was due to refusal, network down, etc.; in which case, the same or another
 ;; address could be tried later. (The socket is still closed, though.)
@@ -637,7 +645,7 @@
             (begin
               (cond-expand
                (windows   ;; WINSOCK--connect failure returned in exceptfds; manually schedule
-                (let ((wait (busy-timeout (or timeout +largest-fixnum+)))) ;; 12.4 days on 32bit
+                (let ((wait (busy-timeout (or timeout most-positive-fixnum)))) ;; 12.4 days on 32bit
                   (let loop ((n 0))
                     (let ((f (select-for-write-or-except s)))
                       (cond ((eq? f -1)
diff --git a/socket.setup b/socket.setup
deleted file mode 100644
index 4bb08bf..0000000
--- a/socket.setup
+++ /dev/null
@@ -1,18 +0,0 @@
-;; -*- scheme -*-
-(compile socket-features.scm)
-(run (./socket-features > socket-config.scm))
-(define defines '())
-
-;; ##sys#scan-buffer-line changed to return 3 values in
-;; 002ea4128f8 and a302a6dcc9 (approximately Chicken 4.8.2).
-(when (version>=? (chicken-version) "4.8.2")
-      (set! defines `(-D scan-buffer-line-returns-3-vals ,@defines)))
-
-(compile -s -O2 -d1 -X socket-config.scm -X feature-test-syntax ,@defines
-         socket-mod.scm -o socket.so -j socket)
-(compile -s -d0 socket.import.scm)
-
-(install-extension
- 'socket
- '("socket.so" "socket.import.so")
- '((version "0.2.7")))
-- 
2.18.0

